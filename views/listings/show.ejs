<% layout('layouts/bp') %>
<body>
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-8">

        <div class="card shadow-lg border-0 mb-3 mt-3">
        <h2 class="card-title text-center fw-bold text-primary mb-4 mt-3"><%= listing.title %></h2>
          <img src="<%= listing.image.url %>" class="card-img-top img-fluid rounded-top" style="height: 350px; object-fit: contain;" alt="Listing Image">

          <div class="card-body">

            <i><%= listing.owner.username %></i>
            
            <ul class="list-group list-group-flush mb-3">
              <li class="list-group-item">
                <strong class="text-dark">Description:</strong>
                <p class="mb-0"><%= listing.description %></p>
              </li>
              <li class="list-group-item">
                <strong class="text-dark">Price:</strong>
                <span class="text-success fw-semibold">‚Çπ<%= listing.price.toLocaleString("en-IN") %></span>
              </li>
              <li class="list-group-item">
                <strong class="text-dark">Location:</strong>
                <%= listing.location %>, <%= listing.country %>
              </li>
            </ul>

            <div class="d-flex justify-content-between mt-4">
              <a href="/listing" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to Listings
              </a>
              <!--  -->
              <% if(currStatus && currStatus._id.equals(listing.owner._id)) {%>
              <a href="/listing/<%= listing._id %>/edit" class="btn btn-warning text-white">
                <i class="bi bi-pencil-fill"></i> Edit
              </a>
              <form method="POST" action="/listing/<%= listing._id %>?_method=DELETE" onsubmit="return confirm('Are you sure you want to delete this listing?')">
                <button type="submit" class="btn btn-danger">
                  <i class="bi bi-trash-fill"></i> Delete
                </button>
                <% } %>
                <!--  -->
              </form>
            </div>
          </div>
          <hr>
          <div class="Review my-5">
            <div class="card border-0 shadow-sm p-4 bg-light">
              <h4 class="card-title mb-4 text-primary fw-bold">
                <i class="bi bi-chat-left-text-fill me-2"></i> Write a Review
              </h4>
              <form action="/listing/<%= listing._id %>/review"class="needs-validation" novalidate method="POST" >
                <div class="mb-4">
                  <label for="rating" class="form-label fw-semibold">Rating</label>
                 
                  <fieldset class="starability-slot">
                    <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
                    <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                    <label for="first-rate1" title="Terrible">1 star</label>
                    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                    <label for="first-rate2" title="Not good">2 stars</label>
                    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                    <label for="first-rate3" title="Average">3 stars</label>
                    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                    <label for="first-rate4" title="Very good">4 stars</label>
                    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                    <label for="first-rate5" title="Amazing">5 stars</label>
                  </fieldset>
            
                </div>
                <div class="mb-4">
                  <label for="comment" class="form-label fw-semibold">Comment</label>
                  <textarea 
                    name="review[comment]" 
                    id="comment" 
                    class="form-control" 
                    rows="4" 
                    required>
                  </textarea>
                  <div class="invalid-feedback">please enter a comment</div>
                </div>
          
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send-fill me-1"></i> Submit Review
                  </button>
                </div>
              </form>
              <hr>
              <div class="mt-5">
                <h4 class="text-primary fw-bold mb-4">
                  <i class="bi bi-stars me-2"></i> All Reviews
                </h4>
                <% if (listing.reviews.length > 0) { %>
                  <ul class="list-group">
                    <% for (let review of listing.reviews) { %>
                      <li class="list-group-item bg-white shadow-sm rounded mb-4">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="mb-1">
                              <i class="bi bi-person-circle text-primary me-1"></i>
                              <span class="fw-bold">@<%= review.author?.username %></span>
                            </h6>
                            <div class="mb-2 d-flex align-items-center">
                              <div class="starability-result small-stars me-2" data-rating="<%= review.rating %>"></div>
                              <small class="text-muted">
                                <i class="bi bi-calendar-event me-1"></i>
                                <%= new Date(review.createdAt).toLocaleDateString('en-IN', {
                                  year: 'numeric',
                                  month: 'short',
                                  day: 'numeric'
                                }) %>
                                
                              </small>
                            </div>
                            
                            
                            <p class="mb-2"><%= review.comment %></p>
                          </div>
                          <% if(currStatus && review.author?._id.equals(currStatus._id)){ %>
                          <form method="POST" action="/listing/<%= listing._id %>/review/<%= review._id %>?_method=DELETE" class="ms-3">
                            <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this review?')">
                              <i class="bi bi-trash-fill"></i> Delete
                            </button>
                          </form>
                          <% } %>
                        </div>
                      </li>
                    <% } %>
                  </ul>
                  
                <% } else { %>
                  <p class="text-muted fst-italic">No reviews yet. Be the first to write one!</p>
                <% } %>
              </div>
              <div class="alert alert-warning text-center mt-4">
                <h5 class="mb-1">üó∫Ô∏è Map Feature Coming Soon</h5>
                <p class="mb-0 small text-muted">We're working on integrating an interactive map to show exact location of listings. Stay tuned!</p>
              </div>
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="/js/script.js"></script>
</body>
